#include "GetAudioBitmap.h"
//#include "ul_log.h"
//#include "mir_sammus_include.h"
//#include "mir_sammus_define.h"

#ifdef SILENCE_DETECTOR_TIME_DOMAIN
	#define REMOVE_BIAS
#endif

#define SILENCE_DETECTOR_SPECTRUM_DOMAIN

#define CHROMA_FLOOR	1.0e-6
#define CHROMA_VALUE_THRESH_MULTIPLY 1.05
#define	MIDI_NOTE_HIGH	108
#define	MIDI_NOTE_LOW	21
#define	MAX_SPEECH_NUM	15

#define FEATURE_EQUALIZATION

static const double NormSigma[619] = {-3.09,-3.08,-3.07,-3.06,-3.05,-3.04,-3.03,-3.02,-3.01,-3.00,-2.99,-2.98,-2.97,-2.96,-2.95,-2.94,-2.93,-2.92,-2.91,-2.90,-2.89,-2.88,-2.87,-2.86,-2.85,-2.84,-2.83,-2.82,-2.81,-2.80,-2.79,-2.78,-2.77,-2.76,-2.75,-2.74,-2.73,-2.72,-2.71,-2.70,-2.69,-2.68,-2.67,-2.66,-2.65,-2.64,-2.63,-2.62,-2.61,-2.60,-2.59,-2.58,-2.57,-2.56,-2.55,-2.54,-2.53,-2.52,-2.51,-2.50,-2.49,-2.48,-2.47,-2.46,-2.45,-2.44,-2.43,-2.42,-2.41,-2.40,-2.39,-2.38,-2.37,-2.36,-2.35,-2.34,-2.33,-2.32,-2.31,-2.30,-2.29,-2.28,-2.27,-2.26,-2.25,-2.24,-2.23,-2.22,-2.21,-2.20,-2.19,-2.18,-2.17,-2.16,-2.15,-2.14,-2.13,-2.12,-2.11,-2.10,-2.09,-2.08,-2.07,-2.06,-2.05,-2.04,-2.03,-2.02,-2.01,-2.00,-1.99,-1.98,-1.97,-1.96,-1.95,-1.94,-1.93,-1.92,-1.91,-1.90,-1.89,-1.88,-1.87,-1.86,-1.85,-1.84,-1.83,-1.82,-1.81,-1.80,-1.79,-1.78,-1.77,-1.76,-1.75,-1.74,-1.73,-1.72,-1.71,-1.70,-1.69,-1.68,-1.67,-1.66,-1.65,-1.64,-1.63,-1.62,-1.61,-1.60,-1.59,-1.58,-1.57,-1.56,-1.55,-1.54,-1.53,-1.52,-1.51,-1.50,-1.49,-1.48,-1.47,-1.46,-1.45,-1.44,-1.43,-1.42,-1.41,-1.40,-1.39,-1.38,-1.37,-1.36,-1.35,-1.34,-1.33,-1.32,-1.31,-1.30,-1.29,-1.28,-1.27,-1.26,-1.25,-1.24,-1.23,-1.22,-1.21,-1.20,-1.19,-1.18,-1.17,-1.16,-1.15,-1.14,-1.13,-1.12,-1.11,-1.10,-1.09,-1.08,-1.07,-1.06,-1.05,-1.04,-1.03,-1.02,-1.01,-1.00,-0.99,-0.98,-0.97,-0.96,-0.95,-0.94,-0.93,-0.92,-0.91,-0.90,-0.89,-0.88,-0.87,-0.86,-0.85,-0.84,-0.83,-0.82,-0.81,-0.80,-0.79,-0.78,-0.77,-0.76,-0.75,-0.74,-0.73,-0.72,-0.71,-0.70,-0.69,-0.68,-0.67,-0.66,-0.65,-0.64,-0.63,-0.62,-0.61,-0.60,-0.59,-0.58,-0.57,-0.56,-0.55,-0.54,-0.53,-0.52,-0.51,-0.50,-0.49,-0.48,-0.47,-0.46,-0.45,-0.44,-0.43,-0.42,-0.41,-0.40,-0.39,-0.38,-0.37,-0.36,-0.35,-0.34,-0.33,-0.32,-0.31,-0.30,-0.29,-0.28,-0.27,-0.26,-0.25,-0.24,-0.23,-0.22,-0.21,-0.20,-0.19,-0.18,-0.17,-0.16,-0.15,-0.14,-0.13,-0.12,-0.11,-0.10,-0.09,-0.08,-0.07,-0.06,-0.05,-0.04,-0.03,-0.02,-0.01,0.00,0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.10,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.20,0.21,0.22,0.23,0.24,0.25,0.26,0.27,0.28,0.29,0.30,0.31,0.32,0.33,0.34,0.35,0.36,0.37,0.38,0.39,0.40,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.50,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.60,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.70,0.71,0.72,0.73,0.74,0.75,0.76,0.77,0.78,0.79,0.80,0.81,0.82,0.83,0.84,0.85,0.86,0.87,0.88,0.89,0.90,0.91,0.92,0.93,0.94,0.95,0.96,0.97,0.98,0.99,1.00,1.01,1.02,1.03,1.04,1.05,1.06,1.07,1.08,1.09,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.50,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.60,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.70,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.80,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.90,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,2.00,2.01,2.02,2.03,2.04,2.05,2.06,2.07,2.08,2.09,2.10,2.11,2.12,2.13,2.14,2.15,2.16,2.17,2.18,2.19,2.20,2.21,2.22,2.23,2.24,2.25,2.26,2.27,2.28,2.29,2.30,2.31,2.32,2.33,2.34,2.35,2.36,2.37,2.38,2.39,2.40,2.41,2.42,2.43,2.44,2.45,2.46,2.47,2.48,2.49,2.50,2.51,2.52,2.53,2.54,2.55,2.56,2.57,2.58,2.59,2.60,2.61,2.62,2.63,2.64,2.65,2.66,2.67,2.68,2.69,2.70,2.71,2.72,2.73,2.74,2.75,2.76,2.77,2.78,2.79,2.80,2.81,2.82,2.83,2.84,2.85,2.86,2.87,2.88,2.89,2.90,2.91,2.92,2.93,2.94,2.95,2.96,2.97,2.98,2.99,3.00,3.01,3.02,3.03,3.04,3.05,3.06,3.07,3.08,3.09};

static const double NormProb[619] = {0.0000,0.0001,0.0001,0.0002,0.0002,0.0003,0.0005,0.0007,0.0010,0.0013,0.0014,0.0014,0.0015,0.0015,0.0016,0.0016,0.0017,0.0018,0.0018,0.0019,0.0019,0.0020,0.0021,0.0021,0.0022,0.0023,0.0023,0.0024,0.0025,0.0026,0.0026,0.0027,0.0028,0.0029,0.0030,0.0031,0.0032,0.0033,0.0034,0.0035,0.0036,0.0037,0.0038,0.0039,0.0040,0.0041,0.0043,0.0044,0.0045,0.0047,0.0048,0.0049,0.0051,0.0052,0.0054,0.0055,0.0057,0.0059,0.0060,0.0062,0.0065,0.0066,0.0068,0.0069,0.0071,0.0073,0.0075,0.0078,0.0080,0.0082,0.0085,0.0087,0.0089,0.0091,0.0094,0.0096,0.0099,0.0102,0.0104,0.0107,0.0110,0.0113,0.0116,0.0119,0.0122,0.0126,0.0129,0.0132,0.0136,0.0139,0.0143,0.0146,0.0150,0.0154,0.0158,0.0162,0.0166,0.0170,0.0174,0.0179,0.0183,0.0188,0.0192,0.0197,0.0202,0.0207,0.0212,0.0217,0.0222,0.0228,0.0233,0.0238,0.0244,0.0250,0.0256,0.0262,0.0268,0.0274,0.0281,0.0287,0.0294,0.0300,0.0307,0.0314,0.0322,0.0329,0.0336,0.0344,0.0352,0.0359,0.0367,0.0375,0.0384,0.0392,0.0401,0.0409,0.0418,0.0427,0.0436,0.0446,0.0455,0.0465,0.0475,0.0485,0.0495,0.0505,0.0516,0.0526,0.0537,0.0548,0.0559,0.0570,0.0582,0.0594,0.0606,0.0618,0.0630,0.0643,0.0655,0.0668,0.0681,0.0694,0.0708,0.0722,0.0735,0.0764,0.0764,0.0778,0.0793,0.0808,0.0823,0.0838,0.0853,0.0869,0.0885,0.0901,0.0918,0.0934,0.0951,0.0968,0.0985,0.1003,0.1020,0.1038,0.1056,0.1075,0.1093,0.1112,0.1131,0.1151,0.1170,0.1190,0.1210,0.1230,0.1251,0.1271,0.1292,0.1314,0.1335,0.1357,0.1379,0.1401,0.1423,0.1446,0.1469,0.1492,0.1515,0.1539,0.1562,0.1587,0.1611,0.1635,0.1660,0.1685,0.1711,0.1736,0.1762,0.1788,0.1814,0.1841,0.1867,0.1894,0.1922,0.1949,0.1977,0.2005,0.2033,0.2061,0.2090,0.2119,0.2148,0.2177,0.2206,0.2236,0.2266,0.2297,0.2327,0.2358,0.2389,0.2420,0.2451,0.2483,0.2514,0.2546,0.2578,0.2611,0.2643,0.2676,0.2709,0.2743,0.2776,0.2810,0.2843,0.2877,0.2912,0.2946,0.2981,0.3015,0.3050,0.3085,0.3121,0.3156,0.3192,0.3228,0.3264,0.3300,0.3336,0.3372,0.3409,0.3446,0.3483,0.3520,0.3557,0.3594,0.3632,0.3669,0.3707,0.3745,0.3783,0.3821,0.3859,0.3897,0.3936,0.3974,0.4013,0.4052,0.4090,0.4129,0.4168,0.4207,0.4247,0.4286,0.4325,0.4361,0.4404,0.4443,0.4483,0.4522,0.4562,0.4602,0.4641,0.4681,0.4721,0.4761,0.4801,0.4840,0.4880,0.4920,0.4960,0.5000,0.5040,0.5080,0.5120,0.5160,0.5199,0.5239,0.5279,0.5319,0.5359,0.5398, 0.5438,0.5478,0.5517,0.5557,0.5596,0.5639,0.5675,0.5714,0.5753,0.5793,0.5832,0.5871,0.5910,0.5948,0.5987,0.6026,0.6064,0.6103,0.6141,0.6179,0.6217,0.6255,0.6293,0.6331,0.6368,0.6406,0.6443,0.6480,0.6517,0.6554,0.6591,0.6628,0.6664,0.6700,0.6736,0.6772,0.6808,0.6844,0.6879,0.6915,0.6950,0.6985,0.7019,0.7054,0.7088,0.7123,0.7157,0.7190,0.7224,0.7257,0.7291,0.7324,0.7357,0.7389,0.7422,0.7454,0.7486,0.7517,0.7549,0.7580,0.7611,0.7642,0.7673,0.7703,0.7734,0.7764,0.7794,0.7823,0.7852,0.7881,0.7910,0.7939,0.7967,0.7995,0.8023,0.8051,0.8078,0.8106,0.8133,0.8159,0.8186,0.8212,0.8238,0.8264,0.8289,0.8315,0.8340,0.8365,0.8389,0.8413,0.8438,0.8461,0.8485,0.8508,0.8531,0.8554,0.8577,0.8599,0.8621,0.8643,0.8665,0.8686,0.8708,0.8729,0.8749,0.8770,0.8790,0.8810,0.8830,0.8849,0.8869,0.8888,0.8907,0.8925,0.8944,0.8962,0.8980,0.8997,0.9015,0.9032,0.9049,0.9066,0.9082,0.9099,0.9115,0.9131,0.9147,0.9162,0.9177,0.9192,0.9207,0.9222,0.9236,0.9236,0.9265,0.9278,0.9292,0.9306,0.9319,0.9332,0.9345,0.9357,0.9370,0.9382,0.9394,0.9406,0.9418,0.9430,0.9441,0.9452,0.9463,0.9474,0.9484,0.9495,0.9505,0.9515,0.9525,0.9535,0.9545,0.9554,0.9564,0.9573,0.9582,0.9591,0.9599,0.9608,0.9616,0.9625,0.9633,0.9641,0.9648,0.9656,0.9664,0.9671,0.9678,0.9686,0.9693,0.9700,0.9706,0.9713,0.9719,0.9726,0.9732,0.9738,0.9744,0.9750,0.9756,0.9762,0.9767,0.9772,0.9778,0.9783,0.9788,0.9793,0.9798,0.9803,0.9808,0.9812,0.9817,0.9821,0.9826,0.9830,0.9834,0.9838,0.9842,0.9846,0.9850,0.9854,0.9857,0.9861,0.9864,0.9868,0.9871,0.9874,0.9878,0.9881,0.9884,0.9887,0.9890,0.9893,0.9896,0.9898,0.9901,0.9904,0.9906,0.9909,0.9911,0.9913,0.9915,0.9918,0.9920,0.9922,0.9925,0.9927,0.9929,0.9931,0.9932,0.9934,0.9935,0.9938,0.9940,0.9941,0.9943,0.9945,0.9946,0.9948,0.9949,0.9951,0.9952,0.9953,0.9955,0.9956,0.9957,0.9959,0.9960,0.9961,0.9962,0.9963,0.9964,0.9965,0.9966,0.9967,0.9968,0.9969,0.9970,0.9971,0.9972,0.9973,0.9974,0.9974,0.9975,0.9976,0.9977,0.9977,0.9978,0.9979,0.9979,0.9980,0.9981,0.9981,0.9982,0.9982,0.9983,0.9984,0.9984,0.9985,0.9985,0.9986,0.9986,0.9987,0.9990,0.9993,0.9995,0.9997,0.9998,0.9998,0.9999,0.9999,1.0000};

static const double bpw[1997] = {0.32377,0.27183,0.15423,0.41954,0.19425,0.38599,0.20350,0.29665,0.24972,0.36458,0.31275,0.41658,0.20832,0.60044,0.22746,0.76465,0.17376,0.43080,0.54256,0.18892,0.65109,0.26474,0.25846,0.61551,0.16074,0.27606,0.60680,0.18032,0.35992,0.63603,0.16164,0.17342,0.48703,0.37570,0.14652,0.41016,0.59967,0.13601,0.18489,0.41501,0.42922,0.11005,0.23802,0.43180,0.42051,0.13095,0.30183,0.50504,0.46299,0.10395,0.15987,0.35308,0.49162,0.25250,0.11792,0.28639,0.49402,0.48484,0.12302,0.10350,0.23981,0.44371,0.50061,0.15280,0.12057,0.26478,0.43973,0.54266,0.25974,0.09946,0.20183,0.36142,0.49312,0.44749,0.12484,0.11198,0.22631,0.37928,0.49714,0.43915,0.13841,0.13897,0.27047,0.43180,0.52531,0.46509,0.17668,0.08355,0.17783,0.30581,0.44071,0.49773,0.41673,0.12735,0.12352,0.26371,0.42565,0.56491,0.60128,0.43181,0.12596,0.08930,0.17081,0.31268,0.43947,0.51425,0.47191,0.26628,0.08021,0.11729,0.20841,0.35260,0.50734,0.55857,0.52876,0.27649,0.09373,0.13558,0.22963,0.36048,0.52378,0.61459,0.54398,0.36141,0.10959,0.07807,0.13184,0.21246,0.32574,0.46117,0.57276,0.57186,0.37812,0.13418,0.10668,0.17486,0.26510,0.37699,0.49110,0.59513,0.59544,0.45045,0.20701,0.07622,0.10406,0.16115,0.23471,0.32169,0.41110,0.49528,0.50748,0.46338,0.25063,0.09560,0.12793,0.18923,0.27155,0.36230,0.45351,0.54166,0.56623,0.56828,0.35951,0.16920,0.09354,0.13863,0.19632,0.27003,0.36063,0.43114,0.50954,0.48683,0.49996,0.38360,0.21031,0.08619,0.10992,0.15820,0.21679,0.29299,0.36972,0.43836,0.50387,0.48376,0.52175,0.35504,0.22422,0.11030,0.14619,0.20579,0.27429,0.35830,0.44608,0.51249,0.58028,0.58079,0.52318,0.47027,0.28332,0.13764,0.09231,0.12567,0.17206,0.23361,0.30423,0.38213,0.44083,0.48859,0.52767,0.44273,0.48542,0.33238,0.22757,0.11830,0.14388,0.20427,0.26687,0.33817,0.42002,0.49711,0.55915,0.62464,0.65338,0.55327,0.52508,0.33493,0.22307,0.11157,0.10394,0.15037,0.20430,0.27040,0.34333,0.42471,0.48164,0.52048,0.56592,0.51338,0.43239,0.46802,0.32784,0.24450,0.13070,0.10937,0.15670,0.21475,0.27854,0.34636,0.42660,0.49665,0.55430,0.55260,0.61562,0.53750,0.48244,0.44816,0.27523,0.22209,0.13953,0.11583,0.16214,0.22581,0.30275,0.39025,0.48232,0.56646,0.63354,0.66237,0.68836,0.67562,0.50199,0.48418,0.42530,0.28411,0.22006,0.12757,0.10615,0.14384,0.20095,0.27121,0.34167,0.42825,0.50924,0.57065,0.61489,0.61713,0.66959,0.61342,0.42917,0.46254,0.37672,0.26379,0.21765,0.14633,0.13177,0.18070,0.25490,0.33351,0.43582,0.53749,0.63283,0.75687,0.82130,0.82427,0.84309,0.83756,0.65945,0.50110,0.50404,0.38400,0.26270,0.20213,0.13281,0.11593,0.14703,0.19877,0.25871,0.33791,0.42577,0.53618,0.63811,0.68256,0.73522,0.74638,0.74103,0.63648,0.50851,0.40058,0.44542,0.40725,0.30673,0.24886,0.17786,0.14653,0.16766,0.23470,0.31506,0.40959,0.50589,0.59827,0.69969,0.78946,0.82386,0.90632,0.91452,0.87247,0.79103,0.67080,0.51433,0.47378,0.39716,0.31527,0.24183,0.19327,0.15590,0.14867,0.18750,0.25166,0.32692,0.41107,0.50773,0.60394,0.69806,0.79453,0.84720,0.93254,0.94243,0.90875,0.74951,0.62757,0.46287,0.41995,0.42178,0.39052,0.29708,0.23316,0.18659,0.16040,0.15306,0.19579,0.25696,0.33487,0.40419,0.49002,0.58723,0.66725,0.74339,0.80163,0.82360,0.83811,0.81638,0.77941,0.70254,0.63547,0.45951,0.40470,0.36295,0.32843,0.26760,0.21849,0.20230,0.18351,0.18478,0.22365,0.28594,0.35518,0.44635,0.54578,0.64302,0.72466,0.82153,0.89949,0.94227,0.93479,0.96981,0.92381,0.78522,0.65452,0.63465,0.52925,0.39600,0.41373,0.38249,0.33482,0.25856,0.20434,0.19188,0.16989,0.16959,0.20177,0.26659,0.32524,0.40445,0.50166,0.59306,0.68581,0.78372,0.83472,0.85960,0.86182,0.86847,0.86522,0.79338,0.68653,0.61166,0.53714,0.42246,0.36225,0.39187,0.38031,0.34197,0.25990,0.23547,0.23195,0.22580,0.21809,0.25193,0.31187,0.38928,0.47794,0.55926,0.66159,0.72020,0.79569,0.87295,0.94628,0.99354,1.00215,1.00902,1.00648,0.92834,0.82767,0.78572,0.76918,0.61910,0.47516,0.41675,0.42394,0.39173,0.30065,0.22951,0.21125,0.21740,0.21207,0.20417,0.21714,0.26731,0.32987,0.42145,0.52462,0.61096,0.70461,0.77476,0.83871,0.91751,0.97443,0.97510,0.97099,0.96206,0.91609,0.77963,0.69526,0.66187,0.61300,0.51699,0.41409,0.40760,0.43621,0.43718,0.37370,0.28395,0.26004,0.24888,0.25540,0.23925,0.24360,0.26074,0.32351,0.41176,0.51293,0.60221,0.70156,0.77496,0.82769,0.87038,0.92258,0.90917,0.91441,0.93280,0.96232,0.98676,0.87894,0.75135,0.69506,0.72127,0.69935,0.60067,0.45838,0.44343,0.45869,0.44595,0.38303,0.30784,0.27233,0.26084,0.26920,0.27007,0.27797,0.28658,0.33666,0.39217,0.48853,0.58922,0.67791,0.76917,0.85509,0.90717,0.94831,0.94703,0.98074,0.95760,0.96841,0.96792,0.89615,0.80963,0.66433,0.63648,0.64306,0.68587,0.68238,0.61086,0.51485,0.48167,0.50226,0.48150,0.39029,0.31510,0.28608,0.27039,0.26946,0.27098,0.27035,0.27367,0.31042,0.34492,0.41477,0.49702,0.58436,0.65636,0.74187,0.81505,0.87821,0.91308,0.92474,0.87786,0.87547,0.92007,0.94402,0.94817,0.89869,0.75999,0.65565,0.64350,0.68836,0.68338,0.66665,0.56819,0.50416,0.46481,0.46959,0.46814,0.41131,0.34959,0.31988,0.31785,0.33572,0.33853,0.35957,0.37237,0.39172,0.43848,0.48540,0.57588,0.65028,0.75776,0.80431,0.86001,0.88262,0.91185,0.97284,0.95510,0.94576,0.98206,0.99587,1.04910,1.03153,0.99204,0.88139,0.81256,0.79832,0.77783,0.78796,0.79843,0.79511,0.68475,0.59609,0.56846,0.54629,0.50352,0.41647,0.35310,0.32951,0.32370,0.33250,0.33886,0.34693,0.35917,0.37060,0.40153,0.41566,0.45749,0.51616,0.60208,0.67977,0.72290,0.82317,0.88445,0.92413,0.95296,0.91298,0.87529,0.83739,0.85156,0.88884,0.94320,0.93564,0.86706,0.78705,0.75565,0.74293,0.75370,0.78885,0.77244,0.74824,0.68592,0.65620,0.58783,0.59857,0.54877,0.47153,0.42259,0.39536,0.38314,0.38794,0.41293,0.43477,0.45284,0.47825,0.52637,0.55421,0.55914,0.59843,0.62116,0.67947,0.78699,0.86387,0.89440,0.91776,0.93807,0.97254,1.01628,0.98233,1.00040,0.96963,0.94991,0.98001,1.00189,0.98431,0.91619,0.90128,0.88245,0.82855,0.89098,0.93003,0.89064,0.81855,0.73524,0.71186,0.66239,0.62675,0.60451,0.53895,0.47823,0.41014,0.38463,0.37440,0.39154,0.41427,0.45322,0.48470,0.52317,0.55751,0.55961,0.59656,0.58975,0.59329,0.66323,0.73730,0.78751,0.81679,0.89468,0.94220,0.98612,1.04963,1.06097,1.01377,0.98325,1.02025,1.04168,1.06980,1.07071,1.04088,0.96164,0.90004,0.88039,0.85461,0.89685,0.90666,0.92653,0.93546,0.88101,0.80682,0.77249,0.74277,0.73626,0.67819,0.60973,0.50312,0.46282,0.43910,0.43258,0.44370,0.45558,0.47969,0.51428,0.54212,0.56927,0.60289,0.64971,0.70550,0.70660,0.69415,0.73912,0.80554,0.82323,0.84115,0.83893,0.86760,0.88741,0.86606,0.90410,0.87483,0.88245,0.93065,0.97510,1.01755,1.00376,0.99950,0.97857,0.92879,0.91570,0.96151,0.95437,0.98312,0.95700,1.00911,0.93351,0.82851,0.74774,0.72730,0.69648,0.70954,0.68336,0.64921,0.60235,0.53811,0.51768,0.49854,0.49986,0.48535,0.50517,0.50921,0.55014,0.56509,0.61458,0.64513,0.68624,0.75344,0.77752,0.79953,0.79773,0.86001,0.91660,0.93456,0.90085,0.94991,0.96588,1.01980,1.01767,1.01753,0.95731,0.91866,0.93685,0.98995,1.03609,1.06254,1.05151,1.05810,1.03194,0.94064,0.92751,0.87898,0.92643,0.90572,0.95619,0.97674,1.01535,0.96939,0.86804,0.82752,0.77899,0.78905,0.77744,0.75727,0.70454,0.60546,0.55794,0.51953,0.51193,0.50090,0.49019,0.51081,0.52483,0.55243,0.58201,0.62423,0.66986,0.68932,0.71964,0.75074,0.76715,0.78737,0.83111,0.85487,0.88883,0.91279,0.90122,0.91518,0.89359,0.91719,0.94991,0.91792,0.84755,0.81014,0.82358,0.81837,0.89666,0.94842,0.96060,0.98372,0.97858,0.93124,0.94119,0.95462,0.97856,0.97166,0.97292,0.93720,0.95220,0.95582,0.87877,0.86818,0.84454,0.85243,0.81053,0.78888,0.75405,0.72223,0.67420,0.61960,0.56409,0.54053,0.54708,0.55102,0.56995,0.58620,0.60949,0.64603,0.67423,0.69989,0.73197,0.77781,0.82978,0.86123,0.91380,0.92186,0.94931,0.95557,0.97186,0.97729,0.95690,0.95359,0.96646,0.95798,0.95024,0.96199,0.95178,0.87346,0.85204,0.87287,0.90487,0.92328,0.94199,0.98489,1.01710,1.02205,1.03923,1.03852,1.04092,1.05672,1.04957,1.06182,1.07475,1.03768,1.03785,1.04330,1.01812,0.95208,0.90098,0.86241,0.83637,0.82797,0.80023,0.78276,0.77927,0.71324,0.65308,0.60546,0.56482,0.54301,0.56338,0.58463,0.59716,0.60620,0.64266,0.66680,0.70140,0.72561,0.73638,0.79991,0.81585,0.87390,0.90100,0.92907,0.97318,1.04082,1.04939,1.01335,0.99302,0.97688,0.95432,0.96154,0.92715,0.98910,1.00016,0.99099,0.94557,0.96705,0.94075,0.92152,0.96121,1.00368,1.01226,1.03841,1.06107,1.03338,1.01841,1.01751,1.04760,1.02874,1.05339,1.10387,1.07611,1.03001,1.06228,1.06123,1.04384,0.97812,0.94873,0.96128,0.96958,0.93970,0.94141,0.93903,0.87771,0.81767,0.76150,0.70684,0.68187,0.66056,0.66544,0.65931,0.67321,0.70889,0.73374,0.76395,0.81518,0.78659,0.84173,0.85887,0.90751,0.95186,0.99655,1.03279,1.07540,1.08248,1.08315,1.09052,1.19053,1.17476,1.16632,1.05316,0.98223,0.94850,0.93820,0.94569,0.98573,0.98400,0.96131,0.93000,0.94732,0.94136,0.96228,1.00675,1.00829,1.04018,1.07531,1.12948,1.13381,1.12698,1.13616,1.17349,1.18579,1.22701,1.18962,1.21881,1.18721,1.18085,1.16819,1.15265,1.04088,1.04456,1.00461,1.01138,1.04236,1.00864,0.99483,0.96182,0.91881,0.86617,0.79090,0.79119,0.76659,0.74923,0.75754,0.76229,0.76965,0.75161,0.77705,0.79592,0.83838,0.85034,0.90310,0.93285,0.97047,1.01537,1.03765,1.10290,1.13287,1.15706,1.15488,1.24352,1.27488,1.29624,1.28805,1.21258,1.21755,1.14158,1.12371,1.12138,1.15196,1.13240,1.16523,1.10643,1.06757,1.10658,1.11747,1.14695,1.18269,1.15890,1.17515,1.20275,1.19324,1.27327,1.25523,1.18369,1.11642,1.12437,1.09205,1.13798,1.16520,1.21825,1.28032,1.29530,1.32619,1.26600,1.21398,1.20698,1.16790,1.09255,1.09742,1.10459,1.15608,1.18364,1.12920,1.10560,1.03332,0.93651,0.91712,0.86343,0.85305,0.85342,0.84852,0.85995,0.85863,0.87331,0.90805,0.89666,0.96392,0.98021,1.02171,1.01964,1.01886,1.05813,1.07450,1.11964,1.14249,1.18694,1.27921,1.29689,1.35786,1.33173,1.32240,1.31764,1.37528,1.28384,1.24500,1.23980,1.28374,1.27801,1.27984,1.28542,1.24876,1.20424,1.20024,1.19960,1.22242,1.26494,1.34415,1.30368,1.29420,1.33122,1.32337,1.33979,1.32648,1.29246,1.30124,1.32858,1.28187,1.25804,1.29835,1.32769,1.31085,1.30747,1.40132,1.43310,1.44238,1.38971,1.31793,1.31089,1.23057,1.16003,1.12183,1.13248,1.14334,1.20417,1.16817,1.15920,1.10665,1.07280,1.03564,1.03722,0.99465,1.01029,1.03895,1.08399,1.06863,1.10239,1.06715,1.11874,1.13931,1.17607,1.28580,1.28182,1.25582,1.21794,1.25311,1.33533,1.30141,1.33157,1.37503,1.33704,1.34631,1.38849,1.47840,1.39773,1.42152,1.45441,1.44710,1.41347,1.38538,1.32747,1.31411,1.31869,1.29635,1.37779,1.40589,1.37258,1.37747,1.36788,1.39912,1.39834,1.36893,1.36062,1.38346,1.40397,1.44419,1.46862,1.48294,1.43916,1.43293,1.40127,1.42662,1.47108,1.39837,1.34370,1.40866,1.44500,1.44669,1.46827,1.49628,1.51814,1.49767,1.47994,1.48355,1.46259,1.45190,1.41958,1.34709,1.31938,1.30263,1.34061,1.33526,1.26772,1.15761,1.14115,1.11067,1.04249,1.03060,1.04738,1.00862,1.04177,1.05579,1.11510,1.12185,1.16194,1.17728,1.17464,1.25490,1.24727,1.22901,1.23229,1.18036,1.20664,1.26929,1.29520,1.30506,1.29967,1.33858,1.39555,1.49945,1.47807,1.46483,1.45527,1.48536,1.50119,1.46602,1.48837,1.47719,1.48563,1.49595,1.47772,1.49502,1.49961,1.48661,1.40316,1.45990,1.50170,1.42821,1.40473,1.39623,1.42103,1.44706,1.51069,1.56219,1.52512,1.58660,1.55072,1.48957,1.39710,1.45669,1.35085,1.32148,1.35616,1.42269,1.44191,1.47291,1.49042,1.42092,1.46256,1.36636,1.43701,1.42521,1.42508,1.44836,1.44240,1.42674,1.38987,1.36292,1.35430,1.32958,1.39112,1.40651,1.35130,1.31908,1.29335,1.23472,1.14833,1.15534,1.16493,1.17840,1.12036,1.14993,1.15335,1.13590,1.21641,1.26573,1.26781,1.26759,1.32720,1.40916,1.38781,1.43065,1.45064,1.43720,1.40292,1.39634,1.32978,1.42357,1.43566,1.45657,1.47951,1.48734,1.41172,1.46509,1.46395,1.50744,1.52225,1.49187,1.45965,1.44632,1.40914,1.40061,1.43567,1.45483,1.41518,1.43985,1.41917,1.46724,1.42071,1.45464,1.57392,1.57202,1.53418,1.52820,1.55277,1.55818,1.53768,1.56118,1.54953,1.57581,1.49140,1.53290,1.52618,1.52509,1.48589,1.55172,1.44908,1.49025,1.53545,1.48508,1.48580,1.54535,1.54333,1.57649,1.53723,1.51823,1.45269,1.43721,1.48125,1.43944,1.46648,1.46060,1.45050,1.41720,1.38676,1.41514,1.40745,1.35124,1.34048,1.26638,1.23658,1.24116,1.16039,1.18046,1.17144,1.16757,1.11428,1.15308,1.12974,1.12259,1.13017,1.21834,1.31080,1.30193,1.33048,1.43244,1.45163,1.45426,1.40425,1.47392,1.51719,1.53773,1.57444,1.53150,1.47462,1.48723,1.54604,1.55747,1.50442,1.49025,1.48267,1.53550,1.55737,1.53646,1.53526,1.51900,1.51932,1.56314,1.52290,1.49477,1.55550,1.58430,1.62155,1.59604,1.53777,1.60090,1.61595,1.58350,1.55560,1.56158,1.55391,1.63795,1.64586,1.73130,1.73072,1.65941,1.67288,1.63898,1.60432,1.59331,1.56419,1.57205,1.57154,1.57539,1.49854,1.46895,1.49199,1.54324,1.47849,1.46946,1.52350,1.53824,1.66091,1.65606,1.57835,1.58783,1.45977,1.48703,1.55188,1.54899,1.53636,1.55003,1.49290,1.53973,1.51396,1.52650,1.52534,1.46078,1.43586,1.33708,1.29038,1.30480,1.33024,1.30876,1.32876,1.28538,1.27859,1.25796,1.33982,1.28333,1.25219,1.26835,1.33193,1.29652,1.32302,1.38536,1.34620,1.35374,1.39753,1.51364,1.51202,1.54063,1.56583,1.57538,1.58972,1.60411,1.57759,1.60603,1.58472,1.58139,1.61858,1.61945,1.62232,1.57771,1.62834,1.60683,1.59783,1.53293,1.54535,1.52766,1.55809,1.59200,1.65455,1.66821,1.61740,1.57977,1.61314,1.59921,1.63841,1.63572,1.65146,1.57871,1.57680,1.59026,1.65564,1.63106,1.60382,1.58696,1.60264,1.59623,1.58860,1.58531,1.59917,1.62035,1.62629,1.65449,1.60602,1.63982,1.53976,1.50133,1.53797,1.52094,1.62778,1.67033,1.67178,1.60056,1.62818,1.66758,1.68151,1.69413,1.61055,1.63755,1.65515,1.60684,1.62246,1.52078,1.50184,1.49659,1.57636,1.54874,1.48922,1.46826,1.46620,1.46720,1.41112,1.43171,1.31211,1.36943,1.35756,1.33616,1.30999,1.39024,1.41418,1.38987,1.36419,1.38761,1.36938,1.41695,1.44410,1.48700,1.51109,1.57670,1.52223,1.43935,1.53343,1.56402,1.59274,1.56278,1.57026,1.60739,1.64053,1.62544,1.61095,1.63290,1.60888,1.52561,1.64448,1.67080,1.69839,1.70755,1.69506,1.62203,1.62533,1.59748,1.58524,1.49110,1.54477,1.48860,1.54465,1.60879,1.65139,1.64960,1.70694,1.72167,1.57404,1.54305,1.57532,1.66374,1.63652,1.63693,1.65558,1.63864,1.64168,1.69833,1.77702,1.81854,1.71820,1.72840,1.76107,1.76830,1.78606,1.80642,1.78537,1.59711,1.66559,1.64319,1.59941,1.55640,1.55968,1.62792,1.56977,1.41107,1.43918,1.58822,1.67106,1.73956,1.76372,1.67944,1.67364,1.72213,1.72986,1.66310,1.66341,1.63910,1.68336,1.67057,1.64642,1.61543,1.60252,1.66266,1.57612,1.62332,1.55321,1.50153,1.37674,1.41735,1.49043,1.54069,1.57416,1.51659,1.46800,1.43559,1.50396,1.50001,1.45467,1.49203,1.50564,1.54709,1.55872,1.59169,1.58235,1.60000,1.57824,1.58578,1.59011,1.59767,1.55190,1.52131,1.61524,1.69447,1.66758,1.72861,1.70237,1.72120,1.78354,1.75460,1.68155,1.79228,1.80394,1.78980,1.76670,1.70655,1.64702,1.62472,1.59846,1.65367,1.74186,1.71490,1.68488,1.69729,1.68495,1.67367,1.70895,1.76665,1.73236,1.74228,1.76725,1.77327,1.79471,1.76191,1.68452,1.71668,1.76110,1.82879,1.81983,1.76780,1.81302,1.83553,1.78207,1.72704,1.66629,1.73045,1.69051,1.77847,1.73411,1.82368,1.80997,1.86026,1.69686,1.75652,1.77613,1.70660,1.75375,1.76600,1.77073,1.74165,1.67161,1.70376,1.72160,1.67377,1.62962,1.67384,1.68423,1.70587,1.66028,1.70232,1.71694,1.62880,1.65243,1.67510,1.76119,1.77353,1.78012,1.70791,1.74569,1.82287,1.84049,1.72661,1.71900,1.70681,1.68345,1.69180,1.64451,1.60501,1.60086,1.52507,1.51741,1.41621,1.41643,1.46014,1.56263,1.62982,1.62368,1.46369,1.51775,1.61999,1.64942,1.60335,1.65444,1.75348,1.77047,1.74681,1.78627,1.80773,1.75859,1.73303,1.71020,1.70654,1.66556,1.67984,1.73141,1.75917,1.76597,1.73849,1.79694,1.87179,1.81813,1.73436,1.65274,1.85295,1.84928,1.83211,1.89068,1.89949,1.93734,1.80983,1.75566,1.72496,1.74326,1.73695,1.69710,1.78280,1.81116,1.82378,1.81967,1.70343,1.68206,1.78746,1.72072,1.74989,1.73791,1.74972,1.71234,1.64236,1.58832,1.61946,1.78596,1.93820,1.93738,1.92851,1.89606,1.83593,1.83177,1.84698,1.84194,1.83395,1.76246,1.84312,1.82183,1.77343,1.72871,1.85595,1.85873,1.84720,1.81183,1.82926,1.83654,1.90136,1.85059,1.88375,1.88779,1.86836,1.81852,1.85558,1.83149,1.84997,1.89118,1.94995,1.96248,1.89227,1.86390,1.82190,1.77596,1.89547,1.95001,1.96654,1.94869,1.92289,2.00038,2.11757,2.22314,2.34576,2.50630,2.76223,3.05039,3.08004};

// added by jiangguohua
const double *my_lower_bound(const double *start, const double *end, double val) {

	assert(start && end && (start < end));
	
	for (const double *ptr = start; ptr < end; ++ptr) {

		if (*ptr >= val) {
			return ptr;
		}
	}

	return end;
}

//setting parameters for extract bitmap
CAudioBitmap::CAudioBitmap(int bitMapTye, float lowfreq, float highfreq, int frameLen, int frameShiftLen, 
		int sampleRate, int blockLen, float threshold, bool isBitOneFrameUse = false, int frameOfindexUint = 100) 
{
	m_lowFreq = lowfreq > 0 ? lowfreq : 0;
	m_highFreq = highfreq < sampleRate / 2 ? highfreq : sampleRate / 2;
	m_frameLen = (UINT32)frameLen;
	m_frameShiftLen = (UINT32)frameShiftLen;
	m_sampleRate = (UINT32)sampleRate;
	m_bitMapType = bitMapTye;
	m_frameOfindexUint = (UINT32)frameOfindexUint;
	//printf("[LowFreq: %.2f][HighFreq: %.2f][FrameLen: %d][FrameShift: %d][SampleRate: %d][BitMapType %d]\n",
	//		m_lowFreq, m_highFreq, m_frameLen, m_frameShiftLen, m_sampleRate, m_bitMapType);

	m_freqNote = new INT16[(int)m_frameLen / 2];
	if(m_freqNote == NULL) 
	{
		printf("[Allocate Memory for m_freqNote Error!]\n");
		m_isSuccess = false;
		return;
	}
	m_bitSizePerUnit = 16;	//split bits in a frame into 16 block, each block is UINT16

	FreqMidinoteMap();
	m_totalsigma_forward = new float[m_chromaDim];
	if(m_totalsigma_forward == NULL)
	{
		printf("[Allocate Memory for m_totalsigmal_forward Error!]\n");
		return;
	}
	m_totalu_forward = new float[m_chromaDim];
	if(m_totalu_forward == NULL)
	{
		printf("[Allocate Memory for m_totalu_forward Error!]\n");
		return;
	}
	m_bitOneFrameIndex = isBitOneFrameUse;	// false
	m_byteSizePerFrame = (INT16)ceil(((float)m_chromaDim) / m_bitSizePerUnit);	// 249 / 16 = 16
	//printf("[ByteSizePerFrame: %d]\n", m_byteSizePerFrame);

	m_codingThreshold = threshold;

#ifdef	FEATURE_EQUALIZATION
	double sigma, prob, tp;
  	int pos;
  	// const double *it = std::lower_bound(NormSigma, NormSigma + 619, -threshold); // by jiangguohua
  	const double *it = my_lower_bound(NormSigma, NormSigma + 619, -threshold);
  	if(it == NormSigma + 619)
	{
		prob = NormProb[618];
	}
  	else
	{
          	prob = NormProb[it-NormSigma];
	}
  	for(int i = 0; i < 1997; i++)
  	{
          	tp = prob*bpw[i];
          	// const double *it2 = std::lower_bound(NormProb, NormProb + 619, tp); // by jiangguohua
          	const double *it2 = my_lower_bound(NormProb, NormProb + 619, tp);
          	if(it2 == NormProb + 619)
		{
                  	sigma = NormSigma[618];
		}
          	else
		{
                  	sigma = NormSigma[it2 - NormProb];
		}
          	m_thresholdArray[i] = -sigma;
	}
#endif
  
	m_totalAudioNum = (UINT32)0;
	m_totalFrameNum = (UINT32)0;

	m_frameSecond = ((float)m_frameLen) / ((float)m_sampleRate);
	m_frameShiftSecond = ((float)m_frameShiftLen) / ((float)m_sampleRate);
	m_blockLen = blockLen;
	m_isSuccess = true;
	m_spectrum = new float[(int)(m_frameLen * 0.5) * MAX_SPEECH_FRAME_LEN];
	if(m_spectrum == NULL) 
	{
		//ul_writelog(UL_LOG_FATAL, "[%s:%d]: Allocate Memory for m_spectrum Error!",
		//		__FILE__, __LINE__);
		m_isSuccess = false;
		return;
	}
	m_bitmap = new UINT16[m_byteSizePerFrame * MAX_SPEECH_FRAME_LEN];
	if(m_bitmap == NULL) 
	{
		printf("[Allocate Memory for m_bitmap Error!]\n");
		m_isSuccess = false;
		return;
	}
	m_realFft = new float[m_frameLen + 1];
	if(m_realFft == NULL) 
	{
		printf("[Allocate Memory for m_realFft Error!]\n");
		m_isSuccess=false;
	}
	m_chroma = new float[m_chromaDim * MAX_SPEECH_FRAME_LEN];
	if(m_chroma == NULL) 
	{
		printf("[Allocate Memory for m_chroma Error!]\n");
		m_isSuccess = false;
	}
	m_sample = new INT16[MAX_SPEECH_FRAME_LEN * (m_frameShiftLen + 1)];
	if(m_sample == NULL) 
	{
		printf("[Allocate Memory for m_sample Error!]\n");
		m_isSuccess = false;
	}
}

CAudioBitmap::~CAudioBitmap() 
{
	if(m_totalu_forward!=NULL)
	{	
		delete[]m_totalu_forward;
		m_totalu_forward = NULL;
	}
	if(m_totalsigma_forward!=NULL)
	{	
		delete[]m_totalsigma_forward;
		m_totalsigma_forward = NULL;
	}
	if(m_spectrum != NULL)
	{
		delete [] m_spectrum;
		m_spectrum = NULL;
	}
	if(m_freqNote != NULL)
	{
		delete [] m_freqNote;
		m_freqNote = NULL;
	}
	if(m_bitmap != NULL)
	{
		delete [] m_bitmap;
		m_bitmap = NULL;
	}
	if(m_realFft != NULL)
	{
		delete [] m_realFft;
		m_realFft = NULL;
	}
	if(m_chroma != NULL)
	{
		delete [] m_chroma;
		m_chroma = NULL;
	}
	if(m_sample != NULL)
	{
		delete [] m_sample;
		m_sample = NULL;
	}
	// m_noteFreqList.clear(); // by jiangguohua
	// m_midiFreq.clear(); // by jiangguohua
}

void CAudioBitmap::ResetVar()
{
	memset(m_sample, 0, MAX_SPEECH_FRAME_LEN * (m_frameShiftLen + 1) * sizeof(INT16));
	memset(m_realFft, 0, sizeof(float) * (m_frameLen + 1));
	memset(m_spectrum, 0, sizeof(float) * ((int)(m_frameLen * 0.5) * MAX_SPEECH_FRAME_LEN));
	memset(m_chroma, 0, sizeof(float) * (m_chromaDim * MAX_SPEECH_FRAME_LEN));
	memset(m_bitmap, 0, sizeof(UINT16) * m_byteSizePerFrame * MAX_SPEECH_FRAME_LEN);
	m_frameNum = 0;
	m_sPos = 0;
	m_ePos = 0;
	m_detectFrameNum = 0;
	// m_bitOneFrame.clear(); // by jiangguohua
}

//获取从当前音乐Package提取的bitmap对应的始末帧位置
int CAudioBitmap::GetPackBitmapPos(int &frameFirst, int &frameLast, unsigned long threadID)
{
	frameFirst = nFrameS;
	//if(abs(PackID) != 2 * PACKNUM_PER_SECOND && abs(PackID) != 3 * PACKNUM_PER_SECOND && abs(PackID) != MAX_SPEECH_NUM)
//	if((abs(PackID) != 3 && abs(PackID) != 5 && abs(PackID) != 9)
//			&& abs(PackID) != MAX_SPEECH_NUM)
//	{
//	    frameLast = nFrameE + m_blockLen - 1;
//	}
//	else
//	{
//	    frameLast = nFrameE;
//	}
    frameLast = nFrameE + m_blockLen - 1;
	if((frameFirst > frameLast && frameLast > 0) || frameFirst < 0)
	{
	    printf("In thread %lu, Package frame number is wrong, PackID: %d,\t frame start: %d\t end: %d\n", 
			    threadID, PackID, nFrameS, nFrameE);
	    return -2;
	}
	if(frameLast < 0)//目前为止获取到的音乐数据量不足以构成一个query block
	{
	    return -1;
	}
	return 0;
}

//设置当前音乐Package的ID和相应的bitmap起始帧位置nFrameS以及当前音乐片段的起始帧位置nRecFrameS
int CAudioBitmap::SetPack(int PID)
{
	PackID = PID;
	if(PackID == 1 || nFrameE < 0)
	{
		nFrameS = 0;
	}
	else
	{
		nFrameS = nFrameE + 1;
	}
	
	if(nFrameS == 0)
	{
		nRecFrameS = 0;
	}
	else
	{
		nRecFrameS = nRecFrameE + 1;
	}

	return 0;
}

//获取当前音乐Package的ID
int CAudioBitmap::GetPackID()
{
	return PackID;
}
	
//convert frequency into midi note
int CAudioBitmap::Freq2Midinote(float freq) 
{
	if(freq <= 0)
	{
		return -1;
	}
	int note = (int)(floor(12 * log((float)(freq / 440)) / log((float)2) + 0.5)) + 69;
	return note;
}

//get class state
bool CAudioBitmap::IsSuccess() 
{
	return m_isSuccess;
}

//在线计算当前音乐package的fft特征，以及该fft特征的末尾帧位置nRecFrameE
////计算前，需要先完成成员变量nFrameS, nRecFrameS, PackID的赋值。
void CAudioBitmap::ComputeFft_Online(short *data, int datalen)
{
	UINT32 ii, id;
	m_frameNum = (int)floor(((float)(datalen - m_frameLen + m_frameShiftLen)) / m_frameShiftLen);
	int halfFft = (int)(m_frameLen / 2);
	
#ifdef SILENCE_DETECTOR_TIME_DOMAIN	// No	
	CheckSilence();
#else
	m_sPos = nRecFrameS;
	m_ePos = m_frameNum - 1;
#endif
	nRecFrameE = m_ePos;
	//extract FFT frame-by-frame
	m_detectFrameNum = m_sPos;
	for(ii = m_sPos; ii <= m_ePos; ii++) 
	{
		UINT32 firstid = m_frameShiftLen * ii;
		INT16 *ptdata = data + firstid;
		m_realFft[0] = 0;
		for(id = 0; id < m_frameLen; id++) 
		{
			m_realFft[id + 1] = (float)ptdata[id];			
		}
		for(id = m_frameLen + 1; id <= m_frameLen; id++)
		{
			m_realFft[id] = 0.0;
		}

		// Pre-emphasis
		/*float fFrameData[2048];
		for(id = 0; id < m_frameLen; id++) 
		{
			fFrameData[id] = (float)ptdata[id];
		}
		for(int kk = 1; kk < m_frameLen; kk++)
		{
			m_realFft[kk + 1] = 2 * fFrameData[kk] - 0.97 * fFrameData[kk -1];
		}
		m_realFft[1] = 2 * fFrameData[0] * (1.0 - 0.97);*/

		Realft(m_realFft, m_frameLen);

		float *pt = m_spectrum + m_detectFrameNum * halfFft;
		//Get spectrum value
		for(int k = 1; k <= halfFft; k++) 
		{
			pt[k - 1] = sqrt(m_realFft[2 * k - 1] * m_realFft[2 * k - 1] + m_realFft[2 * k] * m_realFft[2 * k]);
		}
		m_detectFrameNum++;
	}
}

//在线计算当前音乐package的bitmap, 并给出该bitmap的末尾帧位置nFrameE
//计算前，需要先完成成员变量nFrameS, nRecSample，nRecFrameS, nRecFrameE, PackID的赋值。
int CAudioBitmap::ComputeBitmapFft_Online(int ibandwidth)
{
	unsigned int ii, jj, ii2;
	int kk;
	int bi;
	int bandwidth = ibandwidth;
	m_detectFrameNum = nRecFrameE + 1;
	if(m_detectFrameNum < m_frameOfindexUint / 2 + m_blockLen)
	{
		nFrameE = -1;
		return -1;
	}
	if(m_detectFrameNum < nRecFrameS)
	{
		printf("Package frame number is wrong, PackID: %d,\t received frame start: %d\t received: %d\n", 
				PackID, nRecFrameS, m_detectFrameNum);
		return -2;
	}
	memset(&m_chroma[nRecFrameS * m_chromaDim], 0, sizeof(float) * (m_detectFrameNum - nRecFrameS) * m_chromaDim);
	int dimCt = 0;
	for(ii = 0; ii < (UINT32)(m_frameLen / 2); ii++) 
	{
		INT16 noteid = m_freqNote[ii];
		if(noteid >= 0)
		{
			for(jj = nRecFrameS; jj < m_detectFrameNum; jj++)
			{
				m_chroma[jj * m_chromaDim + dimCt] += m_spectrum[jj * (int)(m_frameLen * 0.5) + ii];
			}
			dimCt++;
		}
	}
	
	//normalize chroma-feature
	for(jj = nRecFrameS; jj < m_detectFrameNum; jj++) 
	{
		float nm = 0;
		float *ptchroma = m_chroma + jj * m_chromaDim;
		for(ii = 0; ii < m_chromaDim; ii++) 
		{
			ptchroma[ii] += CHROMA_FLOOR;
			nm += ptchroma[ii];
		}
		for(ii = 0; ii < m_chromaDim; ii++) 
		{
			ptchroma[ii] = log(ptchroma[ii]) - log(nm);
		}
	}
	
	memset(&m_bitmap[nRecFrameS * m_byteSizePerFrame], 0, 
			sizeof(UINT16) * m_byteSizePerFrame * (m_detectFrameNum - nRecFrameS));
	double chromaValueThresh = -log((double)m_chromaDim) + log(CHROMA_VALUE_THRESH_MULTIPLY);
		
	for(ii2 = 0; ii2 < m_chromaDim; ii2++)
	{
		if(nRecFrameS == 0)
		{
			m_totalu_forward[ii2] = 0;
			m_totalsigma_forward[ii2] = 0;
		}
		//从左向右算
		int byteId;
		byteId = (int)(((float)ii2) / m_bitSizePerUnit);  
		ii = ii2 - m_bitSizePerUnit * byteId;
		unsigned short posbit = 0x0001 << ii;
		float totalu = m_totalu_forward[ii2];
		float totalsigma = m_totalsigma_forward[ii2];
		float val, u, sigma;
		for(kk = (int)nRecFrameS; kk < (int)m_detectFrameNum; kk++) 
		{
			for(bi = ii2; bi < ii2 + bandwidth && bi < m_chromaDim; bi++)
			{
				val = m_chroma[kk * m_chromaDim + bi];
				totalu += val;
				totalsigma += val * val;
			}

			if((kk >= (int)m_blockLen - 1) && (bi == ii2 + bandwidth || bi == m_chromaDim))
			{
				val = m_chroma[kk * m_chromaDim + ii2];
				if(val > chromaValueThresh)
				{
					u = totalu / m_blockLen / (bi - ii2);
					sigma = sqrt(totalsigma / m_blockLen / (bi - ii2) - u * u) + 1.0e-6;
#ifndef	FEATURE_EQUALIZATION
					if((val - u) / sigma > m_codingThreshold)
					{
						m_bitmap[kk * m_byteSizePerFrame + byteId] += posbit;
					}
#else
					if((val - u) / sigma > m_thresholdArray[ii2])
					{
						m_bitmap[kk * m_byteSizePerFrame + byteId] += posbit;
					}
#endif
				}

				for(bi = ii2; bi < ii2 + bandwidth && bi < m_chromaDim; bi++)
				{
					val = m_chroma[(kk - m_blockLen + 1) * m_chromaDim + bi];
					totalu -= val;
					totalsigma -= val * val;
				}
			}
		}
		m_totalu_forward[ii2] = totalu;
		m_totalsigma_forward[ii2] = totalsigma;
		
		//从右向左算
		byteId = (int)(((float)ii2) / m_bitSizePerUnit);  
		ii = ii2 - m_bitSizePerUnit * byteId;
		posbit = 0x0001 << ii;
		totalu = 0;
		totalsigma = 0;
		jj = 0;
		for(kk = m_detectFrameNum - 1; kk >= (int)nFrameS; kk--) 
		{
			for(bi = ii2; bi < ii2 + bandwidth && bi < m_chromaDim; bi++)
			{
				val = m_chroma[kk * m_chromaDim + bi];
				totalu += val;
				totalsigma += val * val;
			}
			if((jj >= m_blockLen - 1) && (bi == ii2 + bandwidth || bi == m_chromaDim))
			{
				val = m_chroma[kk * m_chromaDim + ii2];
				if(val > chromaValueThresh)
				{
					u = totalu / m_blockLen / (bi - ii2);
					sigma = sqrt(totalsigma / m_blockLen / (bi - ii2) - u * u) + 1.0e-6;
#ifndef	FEATURE_EQUALIZATION
					if((val - u) / sigma > m_codingThreshold)
					{
						m_bitmap[kk * m_byteSizePerFrame + byteId] = 
							m_bitmap[kk * m_byteSizePerFrame + byteId] | posbit;
					}
#else
					if((val - u) / sigma > m_thresholdArray[ii2])
					{
						m_bitmap[kk * m_byteSizePerFrame + byteId] = 
							m_bitmap[kk * m_byteSizePerFrame + byteId] | posbit;
					}
#endif
				}
				for(bi = ii2; bi < ii2 + bandwidth && bi < m_chromaDim; bi++)
				{
					val = m_chroma[(kk + m_blockLen - 1) * m_chromaDim + bi];
					totalu -= val;
					totalsigma -= val * val;
				}
			}
			jj++;
		}
	}
	
	//if(abs(PackID) == MAX_SPEECH_NUM || abs(PackID) == 2 * PACKNUM_PER_SECOND || abs(PackID) == 3 * PACKNUM_PER_SECOND)
//	if(abs(PackID) == MAX_SPEECH_NUM || abs(PackID) == 3 || abs(PackID) == 5 || abs(PackID) == 9)
//	{
//		nFrameE = nRecFrameE;
//	}
//	else
//	{
//		nFrameE = nRecFrameE - m_blockLen + 1;
//	}
    nFrameE = nRecFrameE - m_blockLen + 1;
	
	return 0;
}

//在线提取每个音乐 Package的bitmap
int CAudioBitmap::ExtractBitmap_Online(int PID, int ibandwidth)
{
	int i;
	SetPack(PID);

	//在线计算每个音乐 Package的fft特征
	ComputeFft_Online(m_sample, m_sampleNum);

	//在线计算每个音乐 Package的bitmap
	if(i = ComputeBitmapFft_Online(ibandwidth) != 0)
	{
		return i;
	}

	return 0;
}

//return the extracted bitmap feature
UINT16* CAudioBitmap::GetBitmap(int &frameNum) 
{
	frameNum = m_detectFrameNum;
	return m_bitmap;
}

void CAudioBitmap::FreqMidinoteMap() 
{
	int i;
	float freq;
	float freqLow = m_lowFreq;
	float freqHigh = m_highFreq < (float)(m_sampleRate * 0.5) ? m_highFreq : (float)(m_sampleRate * 0.5);
	float freqstep = ((float)m_sampleRate) / ((float)m_frameLen);

	for(i = 0; i < (int)(m_frameLen / 2); i++) 
	{
		m_freqNote[i] = -1;
		freq = i * freqstep;
		if(freq > freqLow && freq < freqHigh) 
		{
			int note = Freq2Midinote(freq);
			if(note == -1)
			{
				continue;
			}
			m_freqNote[i] = note;
		}
	}

	if(m_bitMapType == getFftBit)		// 1 Yes
	{
		for(i = 0; i < (int)(m_frameLen / 2); i++)
		{
			if(m_freqNote[i] >= 0)
			{
				break;
			}
		}
		int d1 = i;
		m_midiNoteLow = m_freqNote[i];
		for(i = (int)(m_frameLen / 2) - 1; i >= 0; i--)
		{
			if(m_freqNote[i] >= 0)
			{
				break;
			}
		}
		int d2 = i;
		m_midiNoteHigh = m_freqNote[i];
		m_chromaDim = (UINT32)(d2 - d1 + 1);
		//printf("[LowMidiNote: %d][HighMidiNote: %d][Dim: %d]\n",
		//		m_midiNoteLow, m_midiNoteHigh, m_chromaDim);
	}
	else if(m_bitMapType == getMidiBit) 	// 2
	{
		for(i = 0; i < (int)(m_frameLen / 2); i++)
		{
			if(m_freqNote[i] >= 0)
			{
				break;
			}
		}
		m_midiNoteLow = m_freqNote[i];
		for(i = (int)(m_frameLen / 2) - 1; i >= 0; i--)
		{
			if(m_freqNote[i] >= 0)
			{
				break;
			}
		}
		m_midiNoteHigh = m_freqNote[i];
		m_chromaDim = (UINT32)(m_midiNoteHigh - m_midiNoteLow + 1);
	}
	else 	// 3
	{
		//default 12-dimension chroma
		m_chromaDim = DEFAULT_CHROMA_DIMENSION;
		for(i = 0; i < (int)(m_frameLen / 2); i++) 
		{
			if(m_freqNote[i] >= 0)
			{
				m_freqNote[i] %= m_chromaDim;
			}
		}
		m_midiNoteLow = 0;
		m_midiNoteHigh = m_chromaDim - 1;
	}
}

//convert midi note to frequency
float CAudioBitmap::Midinote2Freq(int midinote) 
{
	float freq = pow((float)2, (float)(midinote - 69) / 12) * 440;
	return freq;
}

short*	CAudioBitmap::GetDataPtr()
{
	return m_sample;
}

void	CAudioBitmap::SetDataNum(UINT32 nSampleNum)
{
	m_sampleNum = nSampleNum;
}


